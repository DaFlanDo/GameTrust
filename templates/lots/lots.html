{% extends 'base.html' %}
{% block title %}–õ–æ—Ç—ã {{ game.name }} ‚Äî GameTrust{% endblock %}
{% block content %}

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–ª–∞–≤–Ω—ã–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section class="relative pt-8 sm:pt-12 text-center bg-gradient-to-b from-[#1e1b4b] via-[#1c1a40] to-transparent rounded-b-3xl shadow-inner overflow-hidden -mt-6 sm:-mt-8">  <div class="-mt-10 sm:-mt-14 pt-16 sm:pt-24 pb-10 px-4">
    <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-purple-300 to-pink-300 flex items-center justify-center gap-3">
      <span class="text-4xl">üîë</span>
      {{ game.category }} ‚Ä¢ {{ game.name }}
    </h1>
    <p class="text-gray-300 mt-4 text-base sm:text-lg">
      üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã ‚Äî –Ω–∞—Ö–æ–¥–∏—Ç–µ –ª—É—á—à–∏–π –ª–æ—Ç –∑–∞ —Å–µ–∫—É–Ω–¥—ã
    </p>
  </div>
</section>
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="max-w-6xl mx-auto px-4 mb-10">
  <div class="flex flex-wrap justify-center gap-3 text-sm">

    <!-- –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã -->
    {% for p in ['–í—Å–µ', 'PC', 'PlayStation', 'Xbox'] %}
      <a href="?platform={{ p if p != '–í—Å–µ' else '' }}{% if sort %}&sort={{ sort }}{% endif %}{% if auto %}&auto=1{% endif %}"
         class="px-4 py-1.5 rounded-full border transition shadow-sm
                {{ 'bg-indigo-600 text-white border-indigo-600' if platform == p or (p == '–í—Å–µ' and not platform) else 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700 hover:text-white' }}">
        {{ p }}
      </a>
    {% endfor %}

    <!-- –ê–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–∞ -->
    <a href="?auto={% if not auto %}1{% endif %}{% if platform %}&platform={{ platform }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
       class="px-4 py-1.5 rounded-full border transition shadow-sm
              {{ 'bg-indigo-600 text-white border-indigo-600' if auto else 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700 hover:text-white' }}">
      ‚ö° –ê–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–∞
    </a>

    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
    <div class="relative">
      <button id="sortToggle" class="px-4 py-1.5 rounded-full bg-gray-800 border border-gray-700 text-gray-300 hover:text-white hover:bg-gray-700 transition shadow-sm flex items-center gap-2">
        {% if sort == 'price_asc' %}‚¨ÜÔ∏è –¶–µ–Ω–∞{% elif sort == 'price_desc' %}‚¨áÔ∏è –¶–µ–Ω–∞{% elif sort == 'new' %}üÜï –ù–æ–≤—ã–µ{% else %}‚öôÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞{% endif %}
        <svg class="w-4 h-4 text-gray-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>

      <div id="sortDropdown" class="hidden absolute left-0 mt-2 w-48 bg-gray-900 border border-gray-700 rounded-xl shadow-xl z-50 transition-all duration-200">
        {% macro sort_item(label, value, icon) -%}
          <a href="?sort={{ value }}{% if platform %}&platform={{ platform }}{% endif %}{% if auto %}&auto=1{% endif %}"
             class="flex items-center gap-2 px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded
                    {% if sort == value %}bg-gray-700 text-indigo-300 font-semibold{% endif %}">
            <span>{{ icon }}</span> {{ label }}
          </a>
        {%- endmacro %}
        {{ sort_item('–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã', 'price_asc', '‚¨ÜÔ∏è') }}
        {{ sort_item('–ü–æ —É–±—ã–≤–∞–Ω–∏—é —Ü–µ–Ω—ã', 'price_desc', '‚¨áÔ∏è') }}
        {{ sort_item('–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ', 'new', 'üÜï') }}
      </div>
    </div>

  </div>
</div>

<script>
  const sortButton = document.getElementById("sortToggle");
  const sortDropdown = document.getElementById("sortDropdown");

  sortButton.addEventListener("click", function (e) {
    e.stopPropagation();
    sortDropdown.classList.toggle("hidden");
  });

  document.addEventListener("click", function (e) {
    if (!sortDropdown.contains(e.target) && !sortButton.contains(e.target)) {
      sortDropdown.classList.add("hidden");
    }
  });
</script>
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="hidden md:block max-w-6xl mx-auto px-4">
  <div class="overflow-hidden rounded-3xl shadow-2xl ring-1 ring-indigo-700/20">
    <table class="w-full text-sm text-white bg-gray-800/60 backdrop-blur">
      <thead class="bg-gradient-to-r from-gray-800 to-gray-700/80 text-gray-300 uppercase text-[11px]">
        <tr>
          <th class="px-6 py-3 text-left rounded-tl-3xl">üìù –û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th class="px-6 py-3 text-left">üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü</th>
          <th class="px-6 py-3 text-right">üí∞ –¶–µ–Ω–∞</th>
          <th class="px-6 py-3 text-right rounded-tr-3xl"> </th>
        </tr>
      </thead>
      <tbody>
        {% for lot in lots %}
        <tr class="hover:bg-gray-700/70 transition cursor-pointer"
            onclick="window.location.href='{{ url_for('lot.lot', public_id=lot.public_id) }}'">

          <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
          <td class="px-6 py-4 align-top">
            <div class="font-semibold text-indigo-200">{{ lot.title }}</div>
            {% if lot.description %}
              <p class="text-xs text-gray-400 mt-1">{{ lot.description }}</p>
            {% endif %}
            <div class="flex gap-2 text-[11px] text-gray-500 mt-2">
              <span class="px-2 py-0.5 bg-gray-700/60 rounded">{{ lot.platform }}</span>
              {% if lot.autodelivery %}
                <span class="px-2 py-0.5 bg-green-700/50 text-green-300 rounded">‚ö° –ê–≤—Ç–æ</span>
              {% endif %}
            </div>
          </td>

          <!-- –ü—Ä–æ–¥–∞–≤–µ—Ü -->
          <td class="px-6 py-4 align-top">
            <div class="flex items-center gap-3">
              <img src="{{ lot.avatar_url }}" alt class="w-9 h-9 rounded-full object-cover ring-1 ring-gray-600">
              <div>
                <div class="text-sm text-gray-200 font-medium">{{ lot.seller }}</div>
                <div class="flex items-center text-[11px] gap-0.5">
                  {% for i in range(lot.rating_int) %}
                    <span class="text-yellow-400">‚òÖ</span>
                  {% endfor %}
                  {% for i in range(5 - lot.rating_int) %}
                    <span class="text-gray-500">‚òÖ</span>
                  {% endfor %}
                  <span class="ml-1 text-gray-500">({{ lot.rating }})</span>
                </div>
                <p class="text-[11px] text-gray-500 mt-0.5">–ù–∞ —Å–∞–π—Ç–µ: {{ lot.on_site }}</p>
              </div>
            </div>
          </td>

          <!-- –¶–µ–Ω–∞ -->
          <td class="px-6 py-4 align-top text-right whitespace-nowrap">
            <span class="text-lg font-bold text-green-400">{{ lot.price }} ‚ÇΩ</span>
          </td>

          <!-- –ö–Ω–æ–ø–∫–∞ -->
          <td class="px-6 py-4 align-top text-right">
            <a href="{{ url_for('lot.lot', public_id=lot.public_id) }}"
               class="inline-block px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 rounded-full text-xs shadow
                      transition" onclick="event.stopPropagation()">–ö—É–ø–∏—Ç—å</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë -->
{% if has_more %}
<div class="text-center mt-10">
  <button id="load-more-btn"
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full shadow transition">
    ‚è¨ –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë
  </button>
</div>
{% endif %}

<script>
  let currentPage = {{ page|default(1) }};
  const loadMoreBtn = document.getElementById("load-more-btn");

  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", async () => {
      currentPage++;
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

      const params = new URLSearchParams(window.location.search);
      params.set("page", currentPage);

      const res = await fetch(window.location.pathname + "?" + params.toString(), {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if (res.ok) {
        const html = await res.text();
        const temp = document.createElement("div");
        temp.innerHTML = html;

        const newLots = temp.querySelectorAll("tbody tr");
        const lotTable = document.querySelector("tbody");
        newLots.forEach(row => lotTable.appendChild(row));

        if (!temp.querySelector("#load-more-btn")) {
          loadMoreBtn.remove();
        } else {
          loadMoreBtn.disabled = false;
          loadMoreBtn.textContent = "‚è¨ –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë";
        }
      } else {
        loadMoreBtn.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      }
    });
  }
</script>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="md:hidden space-y-6 px-4 max-w-6xl mx-auto">
  {% for lot in lots %}
  <div onclick="window.location.href='{{ url_for('lot.lot', public_id=lot.public_id) }}'"
       class="bg-gray-800/70 backdrop-blur rounded-2xl p-5 ring-1 ring-indigo-700/20
              hover:ring-indigo-500/40 hover:-translate-y-0.5 transition cursor-pointer">

    <div class="flex justify-between items-start mb-3">
      <h3 class="text-lg font-semibold text-indigo-200">{{ lot.title }}</h3>
      <span class="text-lg font-bold text-green-400 whitespace-nowrap">{{ lot.price }} ‚ÇΩ</span>
    </div>

    {% if lot.description %}
      <p class="text-gray-400 text-sm">{{ lot.description[:120] }}{% if lot.description|length > 120 %}‚Ä¶{% endif %}</p>
    {% endif %}

    <div class="flex gap-2 text-xs text-gray-500 mt-3">
      <span class="px-2 py-0.5 bg-gray-700/60 rounded">{{ lot.platform }}</span>
      {% if lot.autodelivery %}
        <span class="px-2 py-0.5 bg-green-700/40 text-green-300 rounded">‚ö° –ê–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–∞</span>
      {% endif %}
    </div>

    <div class="flex items-center gap-3 mt-4">
      <img src="{{ lot.avatar_url }}" alt class="w-8 h-8 rounded-full object-cover ring-1 ring-gray-600">
      <div>
        <div class="text-sm text-gray-200 font-medium">{{ lot.seller }}</div>
        <div class="flex gap-0.5 text-[11px]">
          {% for i in range(lot.rating_int) %}
            <span class="text-yellow-400">‚òÖ</span>
          {% endfor %}
          {% for i in range(5 - lot.rating_int) %}
            <span class="text-gray-500">‚òÖ</span>
          {% endfor %}
          <span class="ml-1 text-gray-500">({{ lot.rating }})</span>
        </div>
      </div>
    </div>

    <a href="{{ url_for('lot.lot', public_id=lot.public_id) }}"
       class="block text-center mt-5 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-full shadow
              text-sm font-medium transition"
       onclick="event.stopPropagation()">–ö—É–ø–∏—Ç—å</a>
  </div>
  {% endfor %}
</div>
    <style>body, main {
  margin: 0;
  padding: 0;
}</style>
{% endblock %}