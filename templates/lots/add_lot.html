{% extends 'base.html' %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –ª–æ—Ç ‚Äî GameTrust{% endblock %}
{% block content %}

<h1 class="text-3xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 mb-10">
  ‚ú® –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ª–æ—Ç
</h1>

<form action="{{ url_for('lot.submit_lot') }}" method="POST" enctype="multipart/form-data"
      class="space-y-8 max-w-3xl mx-auto p-6 bg-gray-800/60 rounded-2xl border border-gray-700 shadow-xl">

  <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
  <div>
    <label class="block text-sm font-semibold mb-2 text-indigo-300">üìõ –ù–∞–∑–≤–∞–Ω–∏–µ</label>
    <input type="text" name="title" required
           class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 placeholder-gray-500 text-white focus:ring-2 focus:ring-indigo-600 focus:outline-none transition">
  </div>

  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è + –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <label class="block text-sm font-semibold mb-2 text-indigo-300">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select name="category" required
              class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white">
        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
        <option value="Accounts">–ê–∫–∫–∞—É–Ω—Ç—ã</option>
        <option value="Keys">–ö–ª—é—á–∏</option>
        <option value="Currency">–í–∞–ª—é—Ç–∞</option>
        <option value="Services">–£—Å–ª—É–≥–∏</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-semibold mb-2 text-indigo-300">üéÆ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
      <select name="platform"
              class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white">
        <option>PC</option>
        <option>PlayStation</option>
        <option>Xbox</option>
      </select>
    </div>
  </div>

  <!-- –ò–≥—Ä–∞ -->
  <div>
    <label class="block text-sm font-semibold mb-2 text-indigo-300">üïπ –ò–≥—Ä–∞</label>
    <select name="game_id" id="gameSelect" required
            class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white">
      <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–Ω–∞—á–∞–ª–∞</option>
    </select>
  </div>

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
  <div>
    <label class="block text-sm font-semibold mb-2 text-indigo-300">üìù –û–ø–∏—Å–∞–Ω–∏–µ</label>
    <textarea name="description" rows="4"
              class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white resize-none focus:ring-2 focus:ring-indigo-600"
              placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –ª–æ—Ç..."></textarea>
  </div>

  <!-- –¶–µ–Ω–∞ + –ê–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–∞ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
    <div>
      <label class="block text-sm font-semibold mb-2 text-indigo-300">üíµ –¶–µ–Ω–∞ (‚ÇΩ)</label>
      <input type="number" name="price" min="0"
             class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white focus:ring-2 focus:ring-indigo-600">
    </div>
    <div class="flex items-center gap-3">
      <input type="checkbox" name="autodelivery" id="autodelivery"
             class="accent-indigo-600 w-5 h-5 rounded bg-gray-900 border-indigo-500">
      <label for="autodelivery" class="text-sm text-indigo-300">‚ö° –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫—É</label>
    </div>
  </div>

  <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
  <div>
    <label class="block text-sm font-semibold mb-2 text-indigo-300">üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
    <input type="number" name="quantity" min="1" value="1"
           class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white focus:ring-2 focus:ring-indigo-600">
  </div>

  <!-- –ê–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–∞ -->
  <div id="autodelivery-data-field" class="mt-6 hidden">
    <label class="block text-sm font-semibold mb-2 text-indigo-300">
      üì§ –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –≤—ã–¥–∞—á–∏ (–ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –Ω–∞ —Ç–æ–≤–∞—Ä)
    </label>
    <textarea name="autodelivery_data" rows="5"
              class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-indigo-500 text-white resize-none focus:ring-2 focus:ring-indigo-600"
              placeholder="login:pass\n–∫–ª—é—á–∏ –∏ —Ç.–¥..."></textarea>
  </div>

  <!-- –°–∫—Ä–∏–Ω—à–æ—Ç—ã -->
  <div class="space-y-3">
    <label class="block text-sm font-semibold text-indigo-300">üñº –°–∫—Ä–∏–Ω—à–æ—Ç—ã</label>
    <input type="file" id="images" name="images[]" accept="image/*" multiple hidden>
    <label for="images" class="inline-flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-indigo-500 to-pink-500 hover:from-indigo-600 hover:to-pink-600 text-white text-sm rounded-lg cursor-pointer transition shadow-md">
      üìé –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
    </label>
    <ul id="fileList" class="text-xs text-gray-400 space-y-1"></ul>
    <div id="preview" class="flex flex-wrap gap-3 mt-3"></div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ -->
  <div class="text-center pt-8">
    <button type="submit"
            class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 px-6 py-3 rounded-xl text-white font-semibold text-lg shadow-lg transition transform hover:scale-105">
      ‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ª–æ—Ç
    </button>
  </div>
</form>

<script>
  // --- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
  document.querySelector('select[name="category"]').addEventListener('change', e => {
    const category = e.target.value;
    const gameSelect = document.getElementById('gameSelect');
    gameSelect.innerHTML = '<option disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    fetch(`/api/games?category=${encodeURIComponent(category)}`)
      .then(r => r.json())
      .then(data => {
        gameSelect.innerHTML = '';
        if (data.length) {
          data.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.name;
            gameSelect.appendChild(opt);
          });
        } else {
          gameSelect.innerHTML = '<option disabled>–ù–µ—Ç –∏–≥—Ä –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
        }
      });
  });

  // --- –∞–≤—Ç–æ–¥–æ—Å—Ç–∞–≤–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ ---
  function toggleAutoField(){
    const box = document.getElementById('autodelivery');
    document.getElementById('autodelivery-data-field').classList.toggle('hidden', !box.checked);
  }
  document.getElementById('autodelivery').addEventListener('change', toggleAutoField);

  // --- –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
  const input   = document.getElementById('images');
  const preview = document.getElementById('preview');
  const fileList= document.getElementById('fileList');

  input.addEventListener('change', () => {
    preview.innerHTML = '';
    fileList.innerHTML = '';
    Array.from(input.files).forEach(file => {
      // –ø—Ä–µ–≤—å—é
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'w-24 h-24 object-cover rounded border border-gray-700';
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
      // —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
      const li = document.createElement('li');
      li.textContent = `üìÅ ${file.name} (${(file.size/1024).toFixed(1)}¬†–ö–ë)`;
      fileList.appendChild(li);
    });
  });
</script>
<script>

  const qtyInput  = document.querySelector('input[name="quantity"]');
  const autoBox   = document.getElementById('autodelivery');
  const autoField = document.querySelector('textarea[name="autodelivery_data"]');

  // —ç–ª–µ–º–µ–Ω—Ç-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  const warn = document.createElement('p');
  warn.className = 'text-red-400 text-sm mt-1 hidden';
  warn.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —á–∏—Å–ª–æ–º —Ç–æ–≤–∞—Ä–æ–≤!';
  autoField.parentNode.appendChild(warn);

  function lineCount(text){
    return text.trim() ? text.trim().split(/\r?\n/).length : 0;
  }

  function validateLines(){
    if (!autoBox.checked) { warn.classList.add('hidden'); return true; }
    const needed = parseInt(qtyInput.value || '0', 10);
    const lines  = lineCount(autoField.value);
    const ok = lines === needed;
    warn.classList.toggle('hidden', ok);
    return ok;
  }

  qtyInput .addEventListener('input', validateLines);
  autoField.addEventListener('input', validateLines);

  // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
  document.querySelector('form').addEventListener('submit', e=>{
    if(!validateLines()){
      e.preventDefault();
      autoField.focus();
    }
  });
</script>
{% endblock %}