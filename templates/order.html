{% extends 'base.html' %}
{% block title %}–ó–∞–∫–∞–∑ #{{ purchase.id }} ‚Äî GameMarket{% endblock %}
{% block content %}

<div class="max-w-3xl mx-auto py-10 px-4 space-y-6">

  <h1 class="text-3xl font-bold text-white">–í–∞—à –∑–∞–∫–∞–∑ #{{ purchase.id }}</h1>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
  <div class="bg-gray-800 rounded-xl p-6 shadow space-y-4 border border-gray-700">
    <div class="text-white font-semibold text-xl">
      {{ purchase.lot_title or "‚ùå –õ–æ—Ç —É–¥–∞–ª—ë–Ω" }}
    </div>

    <div class="text-sm text-gray-400">
      –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ purchase.lot_category or "‚Äî" }} ¬∑
      –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {{ purchase.lot_platform or "‚Äî" }}
    </div>

    {% if purchase.lot_description %}
    <div class="text-sm text-gray-300 leading-relaxed">
      {{ purchase.lot_description }}
    </div>
    {% else %}
    <div class="text-sm text-gray-500 italic">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>
    {% endif %}

<div class="text-sm text-gray-500">
  –ü—Ä–æ–¥–∞–≤–µ—Ü:
  <a href="{{ url_for('profile.user_profile', user_id=purchase.seller_id) }}"
     class="text-indigo-400 hover:underline font-medium">
    {{ purchase.seller_username }}
  </a><br>
  –°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="text-green-400 font-bold">{{ purchase.lot_price }} ‚ÇΩ</span><br>
  –î–∞—Ç–∞: {{ purchase.created_at.strftime('%d.%m.%Y %H:%M') }}<br>
  –°—Ç–∞—Ç—É—Å:
{% if purchase.status == 'paid' %}
  <span class="text-green-400 font-medium">‚úÖ –û–ø–ª–∞—á–µ–Ω</span>
{% elif purchase.status == 'completed' %}
  <span class="text-blue-400 font-medium">üì¶ –ó–∞–≤–µ—Ä—à—ë–Ω</span>
{% else %}
  <span class="text-yellow-400 font-medium">‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è</span>
{% endif %}
</div>
  </div>

  <!-- –ê–≤—Ç–æ–≤—ã–¥–∞—á–∞ -->
  {% if purchase.delivery_data %}
    <div class="bg-indigo-900 rounded-xl p-6 shadow border border-indigo-600 text-left">
      <h2 class="text-white font-bold mb-3 text-lg">üì¶ –í–∞—à —Ç–æ–≤–∞—Ä:</h2>
      <pre class="text-green-400 bg-gray-900 p-4 rounded-lg overflow-auto text-sm">{{ purchase.delivery_data }}</pre>
    </div>
  {% endif %}
{% if purchase.status == 'paid' and not purchase.is_confirmed %}
  <form method="POST" action="{{ url_for('purchase.confirm_receipt', purchase_id=purchase.id) }}">
    <button type="submit"
            class="mt-6 bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg text-white text-sm transition">
      ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    </button>
  </form>
{% endif %}

<!-- –û—Ç–∑—ã–≤ -->
<!-- –û—Ç–∑—ã–≤ -->
{% if purchase.is_reviewed and review %}
  <div class="bg-gray-800 rounded-xl p-6 shadow border border-gray-700 space-y-3">
    {% if request.args.get('edit') == '1' %}
      <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <h2 class="text-white font-semibold text-lg mb-3">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤</h2>
      <form method="POST" action="{{ url_for('review.edit_review', review_id=review.id) }}" class="space-y-4">
        <div class="space-y-3">
          <label class="block text-white font-semibold text-lg">–û—Ü–µ–Ω–∫–∞</label>
          <div class="flex flex-col space-y-2">
            {% for i in range(5, 0, -1) %}
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="rating" value="{{ i }}" {% if review.rating == i %}checked{% endif %} class="accent-yellow-500">
                <span class="text-sm text-yellow-300">{{ '‚òÖ' * i + '‚òÜ' * (5 - i) }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div>
          <label class="block text-sm text-gray-300 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea name="comment" rows="4"
                    class="w-full px-3 py-2 rounded bg-gray-900 border border-indigo-500 text-white"
                    required>{{ review.comment }}</textarea>
        </div>

        <div class="flex gap-3">
          <button type="submit"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          <a href="{{ url_for('purchase.order', purchase_id=purchase.id) }}"
             class="text-sm text-gray-400 hover:text-white self-center">–û—Ç–º–µ–Ω–∞</a>
        </div>
      </form>
    {% else %}
      <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∑—ã–≤–∞ -->
      <div class="flex justify-between items-start">
        <div>
          <h2 class="text-white font-semibold text-lg mb-1">üìù –í–∞—à –æ—Ç–∑—ã–≤</h2>
          <div class="flex items-center gap-2">
            <span class="text-yellow-400 font-bold text-base">‚òÖ {{ review.rating }}/5</span>
            <span class="text-sm text-gray-500">‚Äî {{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
          </div>
        </div>
        <a href="{{ url_for('purchase.order', purchase_id=purchase.id, edit=1) }}"
           class="text-indigo-400 hover:text-indigo-300 text-sm mt-1">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      </div>
      <div class="text-sm text-gray-300 whitespace-pre-wrap border-t border-gray-700 pt-3">
        {{ review.comment }}
      </div>
    {% endif %}
  </div>

{% elif purchase.status == 'completed' and not purchase.is_reviewed %}
  <!-- –ù–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ -->
  <div class="bg-gray-800 rounded-xl p-6 shadow border border-gray-700">
    <h2 class="text-white font-semibold text-lg mb-3">üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
    <form action="{{ url_for('review.submit_review', purchase_id=purchase.id) }}" method="POST" class="space-y-4">
      <div class="space-y-3">
        <label class="block text-white font-semibold text-lg">–û—Ü–µ–Ω–∫–∞</label>
        <div class="flex flex-col space-y-2">
          {% for i in range(5, 0, -1) %}
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="rating" value="{{ i }}" required class="accent-yellow-500">
              <span class="text-sm text-yellow-300">{{ '‚òÖ' * i + '‚òÜ' * (5 - i) }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea name="comment" rows="4"
                  class="w-full px-3 py-2 rounded bg-gray-900 border border-indigo-500 text-white"
                  placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ–º..."></textarea>
      </div>

      <button type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
      </button>
    </form>
  </div>
{% endif %}

<!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
<a href="{{ url_for('purchase.my_orders') }}"
   class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 mt-6 rounded-lg shadow text-sm transition">
  ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑–∞–º
</a>

{% endblock %}