{% extends 'base.html' %}
{% block title %}–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî¬†GameTrust{% endblock %}

{% block content %}
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Flash‚Äë—Å–æ–æ–±—â–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-messages"
         class="fixed top-5 left-1/2 -translate-x-1/2 z-50 space-y-2">
      {% for category, message in messages %}
        <div class="px-4 py-3 rounded-lg shadow-lg text-sm font-medium animate-fade-in-down
                    {{ 'bg-green-600 text-white' if category == 'success'
                       else 'bg-red-600 text-white' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    <script>
      setTimeout(() => document.getElementById('flash-messages')?.remove(), 4000);
    </script>
  {% endif %}
{% endwith %}

<div class="max-w-4xl mx-auto px-4 py-6">
  <h1 class="text-2xl text-indigo-400 font-bold mb-4">üíº –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ë–∞–ª–∞–Ω—Å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="bg-gray-800 p-6 rounded-xl shadow mb-6">
    <p class="text-white text-lg">
      üí∞ –ë–∞–ª–∞–Ω—Å:
      <span class="font-semibold">{{ current_user.balance }}¬†‚ÇΩ</span>
    </p>
    <p class="text-gray-400 text-sm mt-1">üîí –í —É–¥–µ—Ä–∂–∞–Ω–∏–∏: {{ current_user.hold_balance }}¬†‚ÇΩ</p>
    <div class="mt-4 space-x-2">
      <button onclick="toggleModal('topupModal')"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
        –ü–æ–ø–æ–ª–Ω–∏—Ç—å
      </button>
      <button onclick="toggleModal('withdrawModal')"
              class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg">
        –í—ã–≤–µ—Å—Ç–∏
      </button>
    </div>
  </div>

 <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<h2 class="text-indigo-300 text-xl font-semibold mb-3">üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
<div class="grid grid-cols-4 gap-2 px-3 py-2 text-gray-400 text-xs uppercase">
  <div>–î–∞—Ç–∞</div>
  <div>–û–ø–∏—Å–∞–Ω–∏–µ</div>
  <div class="text-right">–°—É–º–º–∞</div>
  <div class="text-right">–°—Ç–∞—Ç—É—Å</div>
</div>

<div class="space-y-2 text-sm">
{% for tx in transactions %}
  {# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –í—ã—á–∏—Å–ª—è–µ–º —Ü–≤–µ—Ç —Å—É–º–º—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
  {% if tx.status == 'pending' %}
      {% set amt_class = 'text-yellow-400' %}
  {% elif tx.status == 'cancelled' %}
      {% set amt_class = 'text-red-400' %}
  {% elif tx.amount > 0 %}
      {% set amt_class = 'text-green-400' %}
  {% else %}
      {% set amt_class = 'text-red-400' %}
  {% endif %}

  <div class="grid grid-cols-4 gap-2 bg-gray-700 rounded p-3">
    <!-- –î–∞—Ç–∞ -->
    <div>{{ tx.created_at.strftime('%d.%m.%Y¬†%H:%M') }}</div>

    <!-- –û–ø–∏—Å–∞–Ω–∏–µ + ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –≤—ã–≤–æ–¥–∞ -->
    <div>
      {{ tx.description }}
      {% if tx.type == 'withdrawal' and tx.status == 'pending' %}
        <form action="{{ url_for('finance.cancel_withdraw', transaction_id=tx.id) }}"
              method="POST" class="inline-block ml-2">
          <button class="text-red-400 hover:underline">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </form>
      {% endif %}
    </div>

    <!-- –°—É–º–º–∞ -->
    <div class="text-right {{ amt_class }}">{{ tx.amount }}¬†‚ÇΩ</div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="text-right">
      {% if tx.status == 'completed' %}
        <span class="text-green-400">–∑–∞–≤–µ—Ä—à—ë–Ω</span>
      {% elif tx.status == 'pending' %}
        <span class="text-yellow-400">–≤¬†–æ–∂–∏–¥–∞–Ω–∏–∏</span>
      {% elif tx.status == 'cancelled' %}
        <span class="text-red-400">–æ—Ç–º–µ–Ω—ë–Ω</span>
      {% else %}
        {{ tx.status }}
      {% endif %}
    </div>
  </div>
{% endfor %}
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="topupModal"
     class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
  <div class="bg-gray-900 p-6 rounded-xl shadow-lg w-full max-w-md relative border border-gray-700">
    <button onclick="toggleModal('topupModal')"
            class="absolute top-2 right-3 text-gray-400 hover:text-white text-xl">&times;</button>

    <h2 class="text-xl font-semibold text-indigo-400 mb-4">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>

    <form method="POST" action="{{ url_for('finance.init_topup') }}">
      <label class="block text-sm text-white mb-2">–°—É–º–º–∞ (‚ÇΩ):</label>
      <input type="number" name="amount" min="10" required
             class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white mb-4">

      <label class="block text-sm text-white mb-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
      <select name="method"
              class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white mb-4">
        <option value="card">üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
        <option value="yoomoney">üí∞¬†–ÆMoney</option>
        <option value="crypto">ü™ô¬†–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
      </select>

      <button type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-semibold">
        –ü–æ–ø–æ–ª–Ω–∏—Ç—å
      </button>
    </form>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–≤–æ–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="withdrawModal"
     class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md relative border border-gray-700">
    <button onclick="toggleModal('withdrawModal')"
            class="absolute top-2 right-3 text-gray-400 hover:text-white text-xl">&times;</button>

    <h2 class="text-xl text-indigo-400 font-bold mb-4">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>

    <form method="POST" action="{{ url_for('finance.withdraw_page') }}">
      <label class="block text-sm text-white mb-2">–°—É–º–º–∞ (‚ÇΩ):</label>
      <input type="number" name="amount" min="1" required
             class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-white">

      <label class="block text-sm text-white mt-4 mb-2">–†–µ–∫–≤–∏–∑–∏—Ç—ã:</label>
      <input type="text" name="details" required
             class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-white">

      <button type="submit"
              class="mt-4 bg-yellow-600 hover:bg-yellow-700 w-full text-white px-4 py-2 rounded">
        –ó–∞–ø—Ä–æ—Å–∏—Ç—å
      </button>
    </form>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
function toggleModal(id) {
  document.getElementById(id)?.classList.toggle('hidden');
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è flash‚Äë—Å–æ–æ–±—â–µ–Ω–∏–π */
const style = document.createElement('style');
style.textContent = `
@keyframes fade-in-down {
  from {opacity:0;transform:translateY(-10px)}
  to   {opacity:1;transform:translateY(0)}
}
.animate-fade-in-down{animation:fade-in-down .4s ease-out}
`;
document.head.appendChild(style);
</script>
{% endblock %}