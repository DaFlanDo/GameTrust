{% extends 'base.html' %}
{% block title %}–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî GameTrust{% endblock %}
{% block content %}

<!-- === 2FA SETUP / STATUS === -->
 <section class="relative min-h-[calc(100vh-6rem)] w-full flex items-center justify-center bg-gradient-to-tr from-[#0e0e16] via-[#15162a] to-[#0e0e16] px-4 py-10 overflow-hidden">  <div class="absolute -top-20 -left-20 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl"></div>
  <div class="absolute -bottom-24 -right-24 w-[32rem] h-[32rem] bg-pink-500/10 rounded-full blur-3xl"></div>

<div class="pointer-events-none absolute -top-20 -left-20 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl"></div>    <div class="absolute -bottom-24 -right-24 w-[32rem] h-[32rem] bg-pink-500/10 rounded-full blur-3xl"></div>
  </div>

  <div class="w-full max-w-lg relative z-10">
    <div class="rounded-3xl bg-white/5 backdrop-blur-md shadow-2xl shadow-black/40 p-8 space-y-8">

      {% if not setup_complete %}
        <!-- ‚îÄ‚îÄ‚îÄ Title & Intro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="space-y-2 text-center">
          <h1 class="text-3xl font-bold tracking-tight text-white flex items-center justify-center gap-2">
            <span class="i-lucide-shield-check text-indigo-400"></span> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ 2‚Äë—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          </h1>
          <p class="text-sm text-zinc-400">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR‚Äë–∫–æ–¥ —á–µ—Ä–µ–∑ Google¬†Authenticator, 1Password –∏–ª–∏ –¥—Ä—É–≥–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ‚Äë–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–¥–æ–≤.</p>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ QR Code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        {% if qr_code %}
        <div class="flex justify-center">
          <img src="data:image/png;base64,{{ qr_code }}" alt="QR¬†Code" class="rounded-xl shadow-xl w-44 h-44 ring ring-indigo-500/20">
        </div>
        {% endif %}

        <!-- ‚îÄ‚îÄ‚îÄ Verification Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <form method="POST" class="space-y-6">
          <div>
            <label class="block mb-2 text-sm font-medium text-indigo-200">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
            <div class="grid grid-cols-6 gap-2">
              {% for i in range(6) %}
              <input type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric"
                     class="code-input w-full aspect-square rounded-lg bg-zinc-900/70 text-center text-2xl font-semibold text-indigo-100 tracking-wider border border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition" />
              {% endfor %}
            </div>
            <input type="hidden" name="code" id="totp-code">
          </div>

          <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 py-3 font-semibold text-white shadow-lg shadow-indigo-600/20 hover:bg-indigo-500 active:scale-[.98] transition">
            <span class="i-lucide-check-circle"></span>
            –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å 2FA
          </button>
        </form>

        <!-- ‚îÄ‚îÄ‚îÄ Backup Codes (first‚Äëtime only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        {% if backup_codes %}
        <div class="rounded-2xl bg-zinc-900/60 border border-zinc-700/60 p-6">
          <h2 class="text-lg font-semibold text-white flex items-center gap-2 mb-2">
            <span class="i-lucide-scroll"></span> –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã
          </h2>
          <p class="text-xs text-zinc-400 mb-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ. –ö–∞–∂–¥—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <strong>–æ–¥–∏–Ω —Ä–∞–∑</strong>.</p>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 font-mono text-sm">
            {% for code in backup_codes %}
              <div class="rounded-lg bg-zinc-800/60 px-3 py-2 text-center text-indigo-200 border border-zinc-700/60 select-all">{{ code }}</div>
            {% endfor %}
          </div>
          <p class="text-[10px] text-center text-zinc-500 mt-4">üîí –ú—ã –Ω–µ –ø–æ–∫–∞–∂–µ–º –∏—Ö —Å–Ω–æ–≤–∞.</p>
        </div>
        {% endif %}

      {% else %}
        <!-- ‚îÄ‚îÄ‚îÄ 2FA Already Enabled ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="space-y-2 text-center">
          <h1 class="text-3xl font-bold tracking-tight text-white flex items-center justify-center gap-2">
            <span class="i-lucide-shield-check"></span> 2‚Äë—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞
          </h1>
          <p class="text-sm text-zinc-400">–ß—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥.</p>
        </div>

        <form method="POST" action="{{ url_for('security.disable_2fa') }}" class="space-y-6">
          <div>
            <label class="block mb-2 text-sm font-medium text-indigo-200">–ö–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
            <div class="grid grid-cols-6 gap-2">
              {% for i in range(6) %}
              <input type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric"
                     class="code-input w-full aspect-square rounded-lg bg-zinc-900/70 text-center text-2xl font-semibold text-indigo-100 tracking-wider border border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition" />
              {% endfor %}
            </div>
          </div>

          <div>
            <label class="block mb-2 text-sm font-medium text-indigo-200">–ò–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥</label>
            <input type="text" name="backup_code" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: a1b2c3d4"
                   class="w-full rounded-lg bg-zinc-900/70 px-4 py-3 font-mono text-sm text-indigo-100 placeholder-zinc-500 border border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition" />
          </div>

          <input type="hidden" name="totp_code" id="totp-code" />

          <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-red-600 py-3 font-semibold text-white shadow-lg shadow-red-600/30 hover:bg-red-500 active:scale-[.98] transition">
            <span class="i-lucide-shield-off"></span>
            –û—Ç–∫–ª—é—á–∏—Ç—å 2FA
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</section>

<!-- === Inline Script to Handle Code Inputs (unchanged) === -->
<script>
  const inputs = document.querySelectorAll('.code-input');

  inputs.forEach((input, index) => {
    input.addEventListener('input', () => {
      if (input.value.length === 1 && index < inputs.length - 1) {
        inputs[index + 1].focus();
      }
      collectCode();
    });

    input.addEventListener('paste', (e) => {
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      if (/^\d{6}$/.test(paste)) {
        e.preventDefault();
        paste.split('').forEach((char, i) => {
          if (inputs[i]) inputs[i].value = char;
        });
        collectCode();
        inputs[5].focus();
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && index > 0) {
        inputs[index - 1].focus();
      }
    });
  });

  function collectCode() {
    const code = Array.from(inputs).map(i => i.value).join('');
    document.getElementById('totp-code').value = code;
  }
</script>
<!-- –ö—Ä–æ—à–µ—á–Ω—ã–π override —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<style>
  /* —É–±–∏—Ä–∞–µ–º –±–æ–∫–æ–≤—ã–µ –ø–∞–¥–¥–∏–Ω–≥–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö */
  main { padding-left: 0 !important; padding-right: 0 !important; }
  /* –Ω–µ –¥–∞—ë–º –ø–æ—è–≤–∏—Ç—å—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø–æ–ª–æ—Å–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
  body { overflow-x: hidden; }
</style>
{% endblock %}
